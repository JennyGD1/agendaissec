<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Maida</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }

        .login-container {
            background-color: #fff;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .login-header {
            margin-bottom: 2rem;
        }

        .login-logo {
            max-width: 150px; 
            height: auto;
            margin-bottom: 15px;
        }

        .login-header p {
            color: #6c757d;
            font-size: 0.95rem;
        }

        .btn-google {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fff;
            font-size: 1rem;
            font-weight: 500;
            color: #333;
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s;
        }

        .btn-google:hover {
            background-color: #f8f9fa;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .btn-google img {
            width: 20px;
            margin-right: 10px;
        }

        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            color: #0066cc;
            font-weight: bold;
        }

        /* === ESTILOS MODAL (Igual aos outros arquivos) === */
        .modal-overlay-custom { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal-content-custom { background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); animation: fadeInModal 0.2s ease-out; }
        @keyframes fadeInModal { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-title-custom { font-size: 1.25rem; font-weight: bold; margin-bottom: 10px; color: #333; }
        .modal-body-custom { font-size: 1rem; color: #555; margin-bottom: 25px; line-height: 1.5; }
        .modal-actions-custom { display: flex; justify-content: center; gap: 15px; }
        .btn-modal-custom { padding: 10px 25px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; font-size: 0.95rem; transition: background 0.2s; }
        .btn-confirm-custom { background-color: #0066cc; color: white; }
        .btn-confirm-custom:hover { background-color: #0056b3; }
    </style>
</head>
<body>
    <div id="loading-overlay">Processando login...</div>

    <div class="login-container">
        <div class="login-header">
            <img src="./img/logo_maidaescura.png" alt="Maida Logo" class="login-logo">
            <p>Utilize suas credenciais do Google para entrar</p>
        </div>
        
        <button class="btn-google" onclick="fazerLoginGoogle()">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google Logo">
            Entrar com Google
        </button>
    </div>

    <div id="modalSistema" class="modal-overlay-custom">
        <div class="modal-content-custom">
            <div id="modalTitulo" class="modal-title-custom">Atenção</div>
            <div id="modalMensagem" class="modal-body-custom"></div>
            <div id="modalBotoes" class="modal-actions-custom"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>

    <script>
        // --- SISTEMA DE MODAIS ---
        function exibirModal(titulo, mensagem) {
            const modal = document.getElementById('modalSistema');
            document.getElementById('modalTitulo').innerText = titulo || 'Aviso';
            document.getElementById('modalMensagem').innerText = mensagem;
            const btnContainer = document.getElementById('modalBotoes');
            btnContainer.innerHTML = '<button class="btn-modal-custom btn-confirm-custom" onclick="fecharModal()">OK</button>';
            modal.style.display = 'flex';
        }

        function fecharModal() {
            document.getElementById('modalSistema').style.display = 'none';
        }

        window.onclick = function(event) {
            const modal = document.getElementById('modalSistema');
            if (event.target == modal) {
                fecharModal();
            }
        }

        // --- FIREBASE E LOGIN ---
        async function iniciarFirebase() {
            try {
                const res = await fetch('http://localhost:3000/api/firebase-config');
                const config = await res.json();
                if (!firebase.apps.length) {
                    firebase.initializeApp(config);
                }

                // Verifica se já está logado
                firebase.auth().onAuthStateChanged(async (user) => {
                    if (user) {
                         await salvarTokenERedirecionar(user);
                    }
                });

            } catch (error) {
                console.error("Erro ao carregar config:", error);
                exibirModal('Erro', "Erro ao conectar com o servidor de autenticação.");
            }
        }

        iniciarFirebase();

        function fazerLoginGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            // Força a seleção de conta para evitar login automático indesejado
            provider.setCustomParameters({
                prompt: 'select_account'
            });
            
            document.getElementById('loading-overlay').style.display = 'flex';

            firebase.auth().signInWithPopup(provider)
                .then(async (result) => {
                    await salvarTokenERedirecionar(result.user);
                })
                .catch((error) => {
                    document.getElementById('loading-overlay').style.display = 'none';
                    console.error("Erro no login:", error);
                    exibirModal('Falha no Login', "Não foi possível autenticar com o Google. Tente novamente.");
                });
        }

        async function salvarTokenERedirecionar(user) {
            try {
                const token = await user.getIdToken();
                localStorage.setItem('maida_token', token);
                localStorage.setItem('maida_user_name', user.displayName || user.email);
                
                window.location.href = 'index.html';
            } catch (error) {
                document.getElementById('loading-overlay').style.display = 'none';
                console.error("Erro ao obter token:", error);
                exibirModal('Erro', "Falha ao processar credenciais.");
            }
        }
    </script>
</body>
</html>